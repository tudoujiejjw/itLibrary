# Git工作流

## 前言

目前的 `git` 协作工作流的模式非常多，我们借鉴主流的 `gitflow` 进而构建我们的协作方式或许还是非常不错的。

无论协作的方式再多，作为一个团队协作开发而言，协作必须有一个规范的工作流程。统一协作开发工作流，这样团队之间既可井然有序、高效地协作开发，同时项目开发迭代也会显得井井有序。


## 工作流

可知，每一个项目的一个端作为一个代码仓库，我们称之为**项目单元**。团队开发 与 维护主要是针对项目单元去开发、迭代甚至是维护，使用分支能够有效地避免不同开发工作之间的相关干扰。

一般而言，一个项目单元必须包括如下类型的分支:


#### 长期存在分支 或 标签

- `main` | 主分支

  主分支属于线上部署的分支，是项目生产稳定运行的项目分支，该分支只能合并 开发分支 或 热修复分支。


- `dev` | 开发分支

  开发分支 与 主分支必须是并行的，此分支基于运行于开发环境 与 测试环境。同时，从规范上面来说，尽量不要在开发分支上直接做开发，开发分支是由功能分支 或 修复分支合并叠成。



#### 短期存在分支

- `feature` | 功能分支

  顾名思义，即功能分支，功能分支是由需求确立而成，每一个需求 或 功能就必须建立一个功能分支，好处就是各个功能独立开发则不受影响，同时团队成员之间的协作隔离不容易产生冲突。

- `fixbug` | 修复分支

  修复分支亦称为补丁分支，假设生产分支出现异常等 `bug` 危急的情况，需要建议一个修复分支，使得主分支合并进而解决 `bug`，注意、修复分支在主分支合并的同时必须由开发分支也合并。



## 规范习惯

#### 高频率、细粒度地提交

把大功能的实现尽可能分解成更多的相对独立的小模块，每个小模块测试完成后提交修改，再开始下一模块的开发。这样做能保证每次提交的内容高度相关，方便定为错误、解决合并冲突。

#### 提交之前务必通过自测

每次提交代码不要自以为然，必须要将改动的代码进行自测，确保开发环境 与 测试环境平稳正常运行，否则会造成持续集成不通过、程序运行失败，甚至影响团队成员之间相互开发协作。

#### 周期性持续提交

经常提交势必让你每次提交的东西都很少，也有助于你只提交相关的改动。并且，你还能更频繁地与别人共享代码。通过这种方式，所有人在集成代码时都会感觉更轻松，也就能避免一些不必要的冲突。相比之下，如果每次提交的东西很多、改动很大、时间间隔很长，那么在代码合并过程中产生的冲突就很难解决了。约定: **在有改动的情况下，至少一天一提交**。

#### 分支合并

- 主分支合并

  主分支合并必须经过测试组测试，验收通过后才能合并。一般而言、每次迭代上线前一步合并。

- 开发分支合并

  开发分支合并功能分支，尽量做到**频繁合并**，也就是说尽量将功能需求分解成 `N` 个功能模块，每一个功能模块完成就提交代码并合并到开发分支，这样可以减少分支合并甚至拉去而造成冲突。

#### 代码提交的姿势
- 支命名规范： **{feature|fixbug}\_{date}\_{function}**

> 1、功能迭代：main -> feature_20230320_order_belong (自测通过后） -> dev (测试通过后） -> main <br>
> 2、多功能迭代：<br>
> main -> feature_20230320_order_belong1 (自测通过后） -> dev (测试通过后） -> main <br>
> main -> feature_20230320_order_belong2 (自测通过后） -> dev (测试通过后） -> main <br>
> 3、热修复：<br>
> main -> fixbug_20230320_order_callback (自测通过后） -> dev (测试通过后） -> main <br>


- **注意：在发布测试/发布上线之前，要先把最新的main合进自己的功能分支中，这样有助于尽早发现与线上版本的冲突问题；**


## 姿势演练


计划会结束，已经确定新的迭代开始，那么需要给予发布 **main** 新建一个版本开发分支

这个迭代有很多功能、不止一个功能，同时进行其他功能分支的建立，比如:

1、创建功能分支

研发 a 需要参与视频模块开发，则需要基于 **main** 创建一个功能分。

```shell
git checkout -b feature_20230320_video origin/main
```



研发 b 需要参与朋友圈模块开发，则需要基于 **main** 创建一个功能分

```shell
git checkout -b feature_20230320_friends_group origin/main
```

**！！！切记千万不要在开发分支直接提交代码 开发分支是合并分支。**



2、研发 a 开发完毕，本地功能测试后，将代码合进 **dev**

```shell
//切换到测试分支
git chekcout dev

//拉取最新的测试分支代码
git pull

//将功能分支合进测试分支
git merge feature/feature_20230320_video

//推送代码至远端
git push origin
```

3、自测完成后，按计划向测试组申请提测

4、提测发现有缺陷，在原有开发分支上进行代码的修改，然后重复步骤【2】

```shell
git merge feature/feature_20230320_video
git merge feature/feature_20230320_friends_group
```



5、测试通过后，将开发分支合进 **main** 分支
```shell
//切换到测试分支
git chekcout main

//拉取最新的测试分支代码
git pull

//将功能分支合进测试分支
git merge feature/feature_20230320_video

//推送代码至远端
git push origin
```

6、对**main**分支进行验证（预发布，暂无）

7、**main**验证通过后，发布至线上

8、没有问题那就将功能分支删除

```shell
git branch -d feature/feature_20230320_video
git branch -d feature/feature_20230320_friends_group
```